# Coolify Build Triggers and Deployment Automation

This guide covers setting up automated build triggers and deployment automation for the andrewford.co.nz blog on Coolify.

## Overview

The deployment automation includes:

- **Git webhook triggers** for automatic deployments on push
- **Branch-based deployment** with staging and production environments
- **Build pipeline configuration** with multi-stage builds
- **Deployment rollback** strategies and blue-green deployments
- **Environment-specific configurations** for different deployment stages
- **Notification integration** for deployment status updates

## Git Integration Setup

### 1. GitHub Repository Configuration

Configure the repository for Coolify integration:

1. **Repository Settings**:

   - Repository: `andrewjamesford/andrewford-co-nz-11ty`
   - Primary Branch: `main` (production)
   - Development Branch: `migrate-from-netlify` (staging)

2. **Webhook Configuration**:
   - URL: `https://your-coolify-server.com/api/v1/webhooks/github`
   - Content Type: `application/json`
   - Events: `push`, `pull_request`
   - Secret: (generated by Coolify)

### 2. Coolify Git Integration

Configure in Coolify dashboard:

1. **Go to Application ‚Üí Source**
2. **Git Repository Settings**:

   - **Repository URL**: `https://github.com/andrewjamesford/andrewford-co-nz-11ty.git`
   - **Branch**: `main`
   - **Auto Deploy**: ‚úÖ Enabled
   - **Deploy Key**: Generated by Coolify
   - **Build Pack**: Docker

3. **Webhook Configuration**:
   - **Enable Webhooks**: ‚úÖ
   - **Webhook URL**: Copy from Coolify dashboard
   - **Secret**: Auto-generated
   - **Events**: Push, Pull Request

## Build Pipeline Configuration

### 1. Build Settings

Configure build pipeline in Coolify:

```yaml
# Build configuration (set in Coolify dashboard)
build:
  context: "."
  dockerfile: "Dockerfile"
  target: "production"
  build_args:
    - NODE_ENV=production
    - API_URL=https://andrewford.co.nz

deployment:
  strategy: "rolling"
  max_surge: 1
  max_unavailable: 0
  timeout: 600 # 10 minutes

health_check:
  enabled: true
  path: "/health"
  port: 3000
  initial_delay: 30
  period: 10
  timeout: 5
  failure_threshold: 3
```

### 2. Multi-Environment Setup

Create separate environments for staging and production:

#### Production Environment (main branch)

```yaml
# Production deployment settings
environment: production
branch: main
domain: andrewford.co.nz
auto_deploy: true
build_args:
  - NODE_ENV=production
  - SITE_URL=https://andrewford.co.nz
  - API_URL=https://andrewford.co.nz
```

#### Staging Environment (migrate-from-netlify branch)

```yaml
# Staging deployment settings
environment: staging
branch: migrate-from-netlify
domain: staging.andrewford.co.nz
auto_deploy: true
build_args:
  - NODE_ENV=staging
  - SITE_URL=https://staging.andrewford.co.nz
  - API_URL=https://staging.andrewford.co.nz
```

## Deployment Workflows

### 1. Automatic Deployment Trigger

The deployment workflow for different scenarios:

```yaml
# .github/workflows/coolify-deploy.yml (optional GitHub Actions integration)
name: Coolify Deployment

on:
  push:
    branches: [main, migrate-from-netlify]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Trigger Coolify deployment
        if: github.ref == 'refs/heads/main'
        run: |
          curl -X POST "${{ secrets.COOLIFY_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"ref": "${{ github.ref }}", "repository": "${{ github.repository }}"}'
```

### 2. Manual Deployment Triggers

Set up manual deployment options in Coolify:

1. **Go to Application ‚Üí Deployments**
2. **Manual Deployment Options**:
   - **Deploy Latest**: Deploy latest commit from configured branch
   - **Deploy Specific Commit**: Deploy from specific commit hash
   - **Rollback**: Revert to previous successful deployment

### 3. Deployment Pipeline Stages

Configure deployment stages:

```yaml
# Deployment pipeline stages
stages:
  - name: "Pre-build"
    commands:
      - echo "Starting deployment for $BRANCH_NAME"
      - docker system prune -f

  - name: "Build"
    commands:
      - docker build -t andrewford-blog:$BUILD_ID .
      - docker tag andrewford-blog:$BUILD_ID andrewford-blog:latest

  - name: "Test"
    commands:
      - docker run --rm andrewford-blog:$BUILD_ID npm test

  - name: "Deploy"
    commands:
      - docker-compose down
      - docker-compose up -d

  - name: "Health Check"
    commands:
      - sleep 30
      - curl -f http://localhost:3080/health || exit 1

  - name: "Post-deploy"
    commands:
      - echo "Deployment completed successfully"
      - docker image prune -f
```

## Branch-Based Deployment Strategy

### 1. Git Flow Integration

Configure branch-based deployments:

```yaml
# Branch deployment mapping
branches:
  main:
    environment: production
    domain: andrewford.co.nz
    auto_deploy: true
    build_command: "docker build --target production ."

  migrate-from-netlify:
    environment: staging
    domain: staging.andrewford.co.nz
    auto_deploy: true
    build_command: "docker build --target production ."

  feature/*:
    environment: preview
    domain: "preview-{branch}.andrewford.co.nz"
    auto_deploy: false
    build_command: "docker build --target production ."
```

### 2. Environment-Specific Configuration

Different configurations per environment:

#### Production Environment Variables

```bash
NODE_ENV=production
SITE_URL=https://andrewford.co.nz
API_URL=https://andrewford.co.nz
ALLOWED_ORIGINS=https://andrewford.co.nz
LOG_LEVEL=info
```

#### Staging Environment Variables

```bash
NODE_ENV=staging
SITE_URL=https://staging.andrewford.co.nz
API_URL=https://staging.andrewford.co.nz
ALLOWED_ORIGINS=https://staging.andrewford.co.nz,http://localhost:3080
LOG_LEVEL=debug
```

## Rollback and Recovery

### 1. Automatic Rollback

Configure automatic rollback on deployment failure:

```yaml
# Rollback configuration
rollback:
  enabled: true
  trigger_on:
    - health_check_failure
    - deployment_timeout
    - container_crash_loop

  strategy: "previous_version"
  max_rollback_attempts: 3
  rollback_timeout: 300 # 5 minutes
```

### 2. Manual Rollback Procedures

Steps for manual rollback:

1. **Identify Last Known Good Deployment**:

   ```bash
   # View deployment history
   curl -X GET "https://your-coolify-server.com/api/v1/applications/{app-id}/deployments"
   ```

2. **Rollback to Specific Version**:

   ```bash
   # Rollback via Coolify API
   curl -X POST "https://your-coolify-server.com/api/v1/applications/{app-id}/rollback" \
     -H "Authorization: Bearer $COOLIFY_TOKEN" \
     -d '{"deployment_id": "previous-deployment-id"}'
   ```

3. **Verify Rollback Success**:
   ```bash
   # Check health after rollback
   curl -f https://andrewford.co.nz/health
   ```

### 3. Blue-Green Deployment

Implement blue-green deployment strategy:

```yaml
# Blue-green deployment configuration
deployment_strategy:
  type: "blue_green"

  blue_environment:
    domain: "blue.andrewford.co.nz"
    containers: 1

  green_environment:
    domain: "green.andrewford.co.nz"
    containers: 1

  switch_strategy:
    health_check_required: true
    manual_approval: false
    automatic_switch_delay: 300 # 5 minutes

  rollback_strategy:
    keep_previous_version: true
    automatic_rollback_on_failure: true
```

## Build Optimization

### 1. Docker Build Cache

Optimize build performance with caching:

```dockerfile
# Build cache optimization in Dockerfile
# Use BuildKit cache mounts
RUN --mount=type=cache,target=/root/.npm \
    npm ci --only=production

# Multi-stage caching
FROM node:20-alpine AS dependencies
WORKDIR /app
COPY package*.json ./
RUN --mount=type=cache,target=/root/.npm \
    npm ci

FROM dependencies AS builder
COPY . .
RUN npm run build

FROM node:20-alpine AS production
COPY --from=dependencies /app/node_modules ./node_modules
COPY --from=builder /app/_site ./_site
```

### 2. Build Performance Settings

Configure build performance in Coolify:

```yaml
# Build performance settings
build:
  parallel_builds: 1
  build_timeout: 1800 # 30 minutes
  cache_enabled: true
  cache_size: "10GB"

  docker_settings:
    build_args_cache: true
    layer_cache: true
    registry_cache: true
```

## Notification Integration

### 1. Deployment Notifications

Set up deployment notifications:

```yaml
# Notification configuration
notifications:
  deployment_started:
    channels: ["slack", "email"]
    message: "üöÄ Deployment started for andrewford.co.nz (branch: {branch})"

  deployment_success:
    channels: ["slack", "email"]
    message: "‚úÖ Deployment successful for andrewford.co.nz (build: {build_id})"

  deployment_failed:
    channels: ["slack", "email", "sms"]
    message: "‚ùå Deployment failed for andrewford.co.nz (error: {error})"

  rollback_triggered:
    channels: ["slack", "email", "sms"]
    message: "üîÑ Rollback triggered for andrewford.co.nz (reason: {reason})"
```

### 2. Slack Integration

Configure Slack webhook for deployment notifications:

1. **Create Slack Webhook**:

   - Go to Slack API: https://api.slack.com/incoming-webhooks
   - Create new webhook for your channel
   - Copy webhook URL

2. **Configure in Coolify**:
   - Go to Settings ‚Üí Notifications
   - Add Slack integration
   - Webhook URL: `https://hooks.slack.com/services/...`
   - Channel: `#deployments`

### 3. Email Notifications

Set up email notifications:

```yaml
# Email notification settings
email:
  smtp_server: "smtp.gmail.com"
  smtp_port: 587
  smtp_user: "notifications@andrewford.co.nz"
  smtp_password: "${SMTP_PASSWORD}"

  recipients:
    deployment_success: ["admin@andrewford.co.nz"]
    deployment_failed: ["admin@andrewford.co.nz", "alerts@andrewford.co.nz"]

  templates:
    deployment_success: |
      Subject: ‚úÖ Deployment Successful - andrewford.co.nz

      The deployment for andrewford.co.nz has completed successfully.

      Details:
      - Branch: {branch}
      - Commit: {commit_hash}
      - Build Time: {build_duration}
      - Environment: {environment}

      View application: https://andrewford.co.nz

    deployment_failed: |
      Subject: ‚ùå Deployment Failed - andrewford.co.nz

      The deployment for andrewford.co.nz has failed.

      Error Details:
      - Branch: {branch}
      - Commit: {commit_hash}
      - Error: {error_message}
      - Build Log: {build_log_url}

      Please investigate and resolve the issue.
```

## Security and Access Control

### 1. Deployment Permissions

Configure deployment access control:

```yaml
# Access control settings
permissions:
  deploy_production:
    users: ["admin@andrewford.co.nz"]
    require_approval: true

  deploy_staging:
    users: ["admin@andrewford.co.nz", "dev@andrewford.co.nz"]
    require_approval: false

  rollback_production:
    users: ["admin@andrewford.co.nz"]
    require_approval: true
    emergency_override: true
```

### 2. API Key Security

Secure API keys in deployment:

```yaml
# Secret management
secrets:
  OPENAI_API_KEY:
    source: "coolify_secret"
    environment: ["production", "staging"]

  OPENROUTER_API_KEY:
    source: "coolify_secret"
    environment: ["production", "staging"]

  LASTFM_API_KEY:
    source: "coolify_secret"
    environment: ["production", "staging"]

  YOUTUBE_API_KEY:
    source: "coolify_secret"
    environment: ["production", "staging"]
```

## Monitoring and Observability

### 1. Deployment Metrics

Track deployment metrics:

```yaml
# Deployment metrics
metrics:
  deployment_frequency: "daily"
  lead_time: "< 1 hour"
  recovery_time: "< 30 minutes"
  change_failure_rate: "< 5%"

  alerts:
    - name: "Deployment Frequency Drop"
      condition: "deployments_per_day < 0.5"

    - name: "High Failure Rate"
      condition: "change_failure_rate > 10%"

    - name: "Long Recovery Time"
      condition: "recovery_time > 60 minutes"
```

### 2. Build Performance Monitoring

Monitor build performance:

```bash
# Build metrics to track
- Build duration (target: < 10 minutes)
- Build success rate (target: > 95%)
- Cache hit rate (target: > 80%)
- Image size (target: < 500MB)
- Deployment time (target: < 5 minutes)
```

## Testing and Validation

### 1. Pre-deployment Testing

Automated testing in deployment pipeline:

```yaml
# Testing stages
testing:
  unit_tests:
    command: "npm test"
    timeout: 300
    required: true

  integration_tests:
    command: "npm run test:integration"
    timeout: 600
    required: true

  api_tests:
    command: "npm run test:api"
    timeout: 300
    required: true

  e2e_tests:
    command: "npm run test:e2e"
    timeout: 900
    required: false # Optional for faster deployments
```

### 2. Post-deployment Validation

Validate deployment success:

```bash
# Post-deployment validation script
#!/bin/bash

echo "üîç Validating deployment..."

# Health check
if ! curl -f https://andrewford.co.nz/health; then
    echo "‚ùå Health check failed"
    exit 1
fi

# API endpoints
if ! curl -f https://andrewford.co.nz/api/lastplayed; then
    echo "‚ùå Last.fm API check failed"
    exit 1
fi

if ! curl -f https://andrewford.co.nz/api/latestUploads; then
    echo "‚ùå YouTube API check failed"
    exit 1
fi

# SSL certificate
if ! openssl s_client -connect andrewford.co.nz:443 -servername andrewford.co.nz </dev/null 2>/dev/null | grep -q "Verify return code: 0"; then
    echo "‚ùå SSL certificate validation failed"
    exit 1
fi

echo "‚úÖ All validation checks passed"
```

## Troubleshooting

### Common Deployment Issues

| Issue                         | Cause                  | Solution                            |
| ----------------------------- | ---------------------- | ----------------------------------- |
| Build timeout                 | Large image/slow build | Optimize Dockerfile, enable caching |
| Health check failures         | App not ready          | Increase health check delay         |
| Webhook not triggering        | Invalid webhook config | Verify webhook URL and secret       |
| Environment variables missing | Config not synced      | Check Coolify environment settings  |
| Container crashes on startup  | Missing dependencies   | Verify package.json and Dockerfile  |

### Deployment Debugging

Debug deployment issues:

```bash
# Check deployment logs
docker logs coolify-app-container

# Check build logs
curl -X GET "https://your-coolify-server.com/api/v1/applications/{app-id}/build-logs"

# Check container status
docker ps -a | grep andrewford-blog

# Test local build
docker build -t test-build .
docker run --rm -p 3000:3000 test-build
```

## Next Steps

After completing build triggers and deployment automation:

1. ‚úÖ Verify webhook integration with GitHub repository
2. ‚úÖ Test automatic deployment on code push
3. ‚úÖ Validate staging environment deployment
4. ‚úÖ Confirm rollback procedures work correctly
5. ‚úÖ Set up notification channels and test alerts
6. ‚úÖ Proceed to staging deployment testing (Task 4.6)
